name: Fetch GitLab Issues Service

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:

jobs:
  run-github:
    runs-on: ubuntu-latest
    continue-on-error: true  # Allow this job to fail without failing the entire workflow

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Install dependencies
        run: |
          cd SheetSync
          npm install

      - name: Run fetchallissues.js
        id: fetch_issues
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          SHEET_SYNC_SID: ${{ secrets.SHEET_SYNC_SID }}
          SHEET_SYNC_SAJ: ${{ secrets.SHEET_SYNC_SAJ }}
          GITLAB_URL: ${{ secrets.GITLAB_URL }}
        run: |
          cd SheetSync
          node fetchallissues.js

      - name: Log results to Google Sheets
        if: always()
        run: |
          # Define the required variables
          JOB_NUMBER=${{ github.run_id }}
          UPDATED_COUNT=$(node -e "import('./SheetSync/fetchallissues.js').then(module => console.log(module.updatedCount));") # Adjust based on your actual implementation
          INSERTED_COUNT=$(node -e "import('./SheetSync/fetchallissues.js').then(module => console.log(module.insertedCount));") # Adjust based on your actual implementation
          
          # Get the current date and time in the desired format
          DATE_TIME=$(date +"%a, %b %d, %Y at %I:%M %p PHT")
          
          # Determine the status based on the previous step
          STATUS="Done"
          if [[ "${{ steps.fetch_issues.outcome }}" == "failure" ]]; then
            STATUS="Failed"
          elif [[ "${{ steps.fetch_issues.outcome }}" == "skipped" ]]; then
            STATUS="Cancelled"
          fi
      
          # Log to Google Sheets using curl
          curl -X POST "https://sheets.googleapis.com/v4/spreadsheets/${SHEET_SYNC_SID}/values/Logs!B3:G3:append?valueInputOption=USER_ENTERED" \
          -H "Authorization: Bearer ${{ secrets.GOOGLE_SHEET_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "values": [
              ["'"$DATE_TIME"'", "'"$JOB_NUMBER"'", "'"$UPDATED_COUNT"'", "'"$INSERTED_COUNT"'", "", "'"$STATUS"'"]
            ]
          }'
